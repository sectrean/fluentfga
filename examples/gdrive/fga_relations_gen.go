// Code generated by fluentfga. DO NOT EDIT.
package fga

import (
	"context"
	"fmt"

	sdk "github.com/openfga/go-sdk"
	sdkclient "github.com/openfga/go-sdk/client"
)

type Relation interface {
	typeName() string
	relation() string
	String() string
}

type RelationOperations[O Object] interface {
	Check(ctx context.Context, user Object, object O, opts ...CheckOption) (bool, error)
	ListObjects(ctx context.Context, user Object, opts ...ListObjectsOption) ([]O, error)
	ListUsers(ctx context.Context, object O, opts ...ListUsersOption) ([]Object, error)
}

type DirectRelationOperations[U Object, O Object] interface {
	RelationOperations[O]
	Write(ctx context.Context, user U, object O, opts ...WriteOption) error
	Delete(ctx context.Context, user U, object O, opts ...WriteOption) error
}

type relation[O Object] struct {
	client sdkclient.SdkClient
	typ    string
	rel    string
}

func (r relation[O]) typeName() string { return r.typ }
func (r relation[O]) relation() string { return r.rel }
func (r relation[O]) String() string   { return fmt.Sprint(r.typ, "#", r.rel) }

func (r relation[O]) Check(ctx context.Context, user Object, object O, opts ...CheckOption) (bool, error) {
	req := r.client.Check(ctx).
		Body(sdkclient.ClientCheckRequest{
			User:     user.String(),
			Relation: r.relation(),
			Object:   object.String(),
		})

	for _, opt := range opts {
		opt.applyCheckOption(req)
	}

	res, err := req.Execute()
	if err != nil {
		return false, err
	}

	return res.GetAllowed(), nil
}

func (r relation[O]) ListObjects(ctx context.Context, user Object, opts ...ListObjectsOption) ([]O, error) {
	req := r.client.ListObjects(ctx).
		Body(sdkclient.ClientListObjectsRequest{
			User:     user.String(),
			Relation: r.relation(),
		})

	for _, opt := range opts {
		opt.applyListObjectsOption(req)
	}

	data, err := req.Execute()
	if err != nil {
		return nil, err
	}

	return newObjects[O](data.Objects)
}

func (r relation[O]) ListUsers(ctx context.Context, object O, opts ...ListUsersOption) ([]Object, error) {
	req := r.client.ListUsers(ctx).
		Body(sdkclient.ClientListUsersRequest{
			Object: sdk.FgaObject{
				Type: object.typeName(),
				Id:   object.identifier(),
			},
			Relation: r.relation(),
		})

	for _, opt := range opts {
		opt.applyListUsersOption(req)
	}

	data, err := req.Execute()
	if err != nil {
		return nil, err
	}

	return newUsers(data.Users)
}

type directRelation[U Object, O Object] struct {
	relation[O]
}

func (r directRelation[U, O]) Write(ctx context.Context, user U, object O, opts ...WriteOption) error {
	req := r.client.Write(ctx).
		Body(sdkclient.ClientWriteRequest{
			Writes: []sdkclient.ClientTupleKey{
				{
					User:     user.String(),
					Relation: r.rel,
					Object:   object.String(),
				},
			},
		})

	for _, opt := range opts {
		opt.applyWriteOption(req)
	}

	_, err := req.Execute()
	if err != nil {
		return err
	}

	return nil
}

func (r directRelation[U, O]) Delete(ctx context.Context, user U, object O, opts ...WriteOption) error {
	req := r.client.Write(ctx).
		Body(sdkclient.ClientWriteRequest{
			Deletes: []sdkclient.ClientTupleKeyWithoutCondition{
				{
					User:     user.String(),
					Relation: r.rel,
					Object:   object.String(),
				},
			},
		})

	for _, opt := range opts {
		opt.applyWriteOption(req)
	}

	_, err := req.Execute()
	if err != nil {
		return err
	}

	return nil
}
