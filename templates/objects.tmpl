{{- /*gotype: github.com/johnrutherford/fluentfga.Model*/ -}}

{{ define "objects" }}
{{ template "_header" . }}

type Object interface {
    typeName() string
    id() string
    String() string
}

type Userset interface {
    Object
    Relation
}

type ContextualTuple interface {
    tuple() sdkclient.ClientTupleKey
}

{{ range .Types }}
// {{ .Type }} represents an object of the "{{ .Name }}" type.
type {{ .Type }} struct {
    {{ .IDName }} {{ .IDType }}
}

func ({{ .Type }}) typeName() string { return "{{ .Name }}" }
func ({{ abbr .Type }} {{ .Type }}) id() string { return fmt.Sprint({{ abbr .Type }}.{{ .IDName }}) }
func ({{ abbr .Type }} {{ .Type }}) String() string { return fmt.Sprint("{{ .Name }}:", {{ abbr .Type }}.{{ .IDName }}) }

{{ if .HasWildcard }}
{{ $wildcardType := print .Type "Wildcard" }}
// {{ $wildcardType }} represents public access: "{{ .Name }}:*".
type {{ $wildcardType }} struct{}

func ({{ $wildcardType }}) typeName() string { return "{{ .Name }}" }
func ({{ $wildcardType }}) id() string { return "*" }
func ({{ $wildcardType }}) String() string { return "{{ .Name }}:*" }

{{ end }}

{{ range .Usersets }}
{{ $usersetType := print .Type }}
// {{ $usersetType }} is the "{{ .Object.Name }}:{{ print "{" .Object.IDName "}" }}#{{ .Relation }}" userset.
type {{ $usersetType }} struct {
    {{ .Object.Type }}
}

func ({{ $usersetType }}) relation() string { return "{{ .Relation }}" }
func (u {{ $usersetType }}) String() string { return fmt.Sprint("{{ .Object.Name }}:", u.id(), "#{{ .Relation }}") }

// {{ .Object.Type }}Userset returns the "{{ .Object.Name }}:{{ print "{" .Object.IDName "}" }}#{{ .Relation }}" userset.
func ({{ abbr .Object.Type }} {{ .Object.Type }}) {{ titleCase .Relation }}Userset() {{ $usersetType }} {
    return {{ $usersetType }}{ {{ abbr .Object.Type }} }
}

{{ end }}

{{ end }}

func parseObject[O Object](s string) (o O, _ error) {
    parts := strings.Split(s, ":")
    if len(parts) != 2 {
        return o, fmt.Errorf("invalid object: %q", s)
    }

    object := newObject(parts[0], parts[1])

    o, ok := object.(O)
    if !ok {
        return o, fmt.Errorf("unexpected object type: %q", s)
    }

    return o, nil
}

func newObjects[O Object](objs []string) ([]O, error) {
    objects := make([]O, 0, len(objs))
    var errs []error

    for _, s := range objs {
        obj, err := parseObject[O](s)
        if err != nil {
            errs = append(errs, err)
            continue
        }

        objects = append(objects, obj)
    }

    return objects, errors.Join(errs...)
}

func newObject(typ, id string) Object {
    switch typ {
{{- range .Types }}
    case "{{ .Name }}":
        return {{ .Type }}{ {{ .IDName }}: id }
{{- end }}

    default:
        return unknownObject{typ, id}
    }
}

func newUsers(data []sdk.User) ([]Object, error) {
    users := make([]Object, 0, len(data))
    var errs []error

    for _, u := range data {
        user, err := newUser(u)
        if err != nil {
            errs = append(errs, err)
            continue
        }

        users = append(users, user)
    }

    return users, errors.Join(errs...)
}

func newUser(u sdk.User) (Object, error) {
    if u.Object != nil {
        return newObject(u.Object.Type, u.Object.Id), nil
    }
    if u.Userset != nil {
        return newUserset(u.Userset.Type, u.Userset.Id, u.Userset.Relation), nil
    }
    if u.Wildcard != nil {
        return newObject(u.Wildcard.Type, "*"), nil
    }

    return nil, fmt.Errorf("unknown user type %v", u)
}

func newUserset(typ, id, rel string) Userset {
{{- range .Types }}
{{- range .Usersets }}
    if typ == "{{ .Object.Name }}" && rel == "{{ .Relation }}" {
        return {{ .Type }}{ {{ .Object.Type }} { {{ .Object.IDName }}: id } }
    }
{{- end }}
{{- end }}

    return unknownUserset{typ, id, rel}
}

// unknownObject represents an object of an unknown type.
//
// If the authorization model version used by OpenFGA is different from the one this code was generated for,
// it's possible that the server will return objects that are not known to this code.
type unknownObject struct {
    objType, objID string
}

func (o unknownObject) typeName() string { return o.objType }
func (o unknownObject) id() string { return o.objID }
func (o unknownObject) String() string { return fmt.Sprint(o.objType, ":", o.objID) }

type unknownUserset struct {
    objType, objID, rel string
}

func (u unknownUserset) typeName() string { return u.objType }
func (u unknownUserset) id() string { return u.objID }
func (u unknownUserset) relation() string { return u.rel }
func (u unknownUserset) String() string { return fmt.Sprint(u.objType, ":", u.objID, '#', u.rel) }


{{ end }}
